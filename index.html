<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>Ads - Earn DOGS</title>
  <meta name="viewport" content="width=340, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: #ffffff;
      font-family: 'Inter', Arial, sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
      font-size: 13px;
    }
    .container {
      width: 340px;
      margin: 0 auto;
      padding: 12px 8px 90px 8px;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 14px;
      padding: 14px;
      text-align: center;
      margin-bottom: 14px;
      box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .header-title {
      font-size: 1em;
      font-weight: 700;
      letter-spacing: 1px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    /* Complete Earnings Box */
    .earnings-box {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(10px);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    .earnings-title {
      font-size: 0.95em;
      font-weight: 600;
      margin-bottom: 12px;
      color: #f0f0f0;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-align: center;
    }
    .earning-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      margin-bottom: 8px;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .earning-label {
      font-size: 0.9em;
      font-weight: 500;
      color: #e0e0e0;
    }
    .earning-value {
      font-size: 0.9em;
      font-weight: 600;
    }
    .balance-value { color: #4ade80; }
    .total-earning-value { color: #f59e0b; }
    .today-earning-value { color: #3b82f6; }

    /* Ads Section */
    .ads-section {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(10px);
      border-radius: 14px;
      padding: 16px;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      margin-bottom: 16px;
    }
    .section-title {
      font-size: 0.95em;
      font-weight: 600;
      margin-bottom: 12px;
      color: #f0f0f0;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .ad-item {
      background: rgba(255,255,255,0.03);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 12px;
      border: 1px solid rgba(255,255,255,0.05);
      text-align: center;
    }
    .ad-title {
      font-size: 1em;
      font-weight: 600;
      color: #f0f0f0;
      margin-bottom: 8px;
    }
    .ad-reward {
      font-size: 0.9em;
      color: #4ade80;
      font-weight: 500;
      margin-bottom: 12px;
    }
    .ad-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 0.95em;
      font-weight: 600;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.3s;
      width: 100%;
      max-width: 200px;
      display: inline-block; /* To allow max-width to work */
    }
    .watch-btn {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(139,92,246,0.3);
    }
    .watch-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(139,92,246,0.4);
    }
    .countdown-btn {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      cursor: not-allowed;
      box-shadow: 0 2px 8px rgba(245,158,11,0.3);
    }
    .claim-btn {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(16,185,129,0.3);
      animation: pulse 2s infinite;
    }
    .claim-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(16,185,129,0.4);
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 340px;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px 20px 0 0;
      padding: 16px 12px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 100;
    }
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      padding: 8px 8px;
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      min-width: 50px;
      flex: 1;
      margin: 0 2px;
    }
    .nav-item:hover {
      background: rgba(255,255,255,0.1);
      transform: translateY(-2px);
    }
    .nav-item.active {
      background: rgba(102,126,234,0.2);
      border-color: rgba(102,126,234,0.3);
    }
    .nav-icon {
      width: 22px; height: 22px; margin-bottom: 4px;
      background: #fff;
      mask-size: contain;
      mask-repeat: no-repeat;
      mask-position: center;
    }
    .nav-home .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m3 12 2-2m0 0 7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6'/%3E%3C/svg%3E"); }
    .nav-ads .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z'/%3E%3C/svg%3E"); }
    .nav-task .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'/%3E%3C/svg%3E"); }
    .nav-wallet .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z'/%3E%3C/svg%3E"); }
    .nav-label {
      font-size: 0.7em;
      font-weight: 500;
      color: #e0e0e0;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    /* Responsive */
    @media (max-width: 360px) {
      .container { width: 100%; padding: 7px 3px 90px 3px; }
      .bottom-nav { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-title" id="telegram-id">Loading User...</div>
    </div>

    <!-- Earnings Summary Box -->
    <div class="earnings-box">
      <div class="earnings-title">üìä Earnings Summary</div>
      <div class="earning-item">
        <div class="earning-label">üí∞ Balance:</div>
        <div class="earning-value balance-value" id="balance-display">... DOGS / ... USDT</div>
      </div>
      <div class="earning-item">
        <div class="earning-label">üìà Total Earning:</div>
        <div class="earning-value total-earning-value" id="total-earning">... DOGS / ... USDT</div>
      </div>
      <div class="earning-item">
        <div class="earning-label">‚≠ê Today Earning:</div>
        <div class="earning-value today-earning-value" id="today-earning">... DOGS / ... USDT</div>
      </div>
    </div>

    <!-- Ads Section -->
    <div class="ads-section">
      <div class="section-title">üé¨ Watch Ads & Earn</div>

      <div class="ad-item">
        <div class="ad-title">üíé Premium Video Ad</div>
        <div class="ad-reward">+ 10 DOGS per ad</div>
        <button class="ad-btn watch-btn" id="ad-button-premium">
          Watch Ad
        </button>
      </div>

      <div class="ad-item">
        <div class="ad-title">üöÄ Sponsored Content</div>
        <div class="ad-reward">+ 15 DOGS per view</div>
        <button class="ad-btn watch-btn" id="ad-button-sponsored">
          Coming Soon
        </button>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <div class="nav-item nav-home" onclick="window.location.href='index.html'">
      <div class="nav-icon"></div>
      <span class="nav-label">Home</span>
    </div>
    <div class="nav-item nav-ads active" onclick="window.location.href='ads.html'">
      <div class="nav-icon"></div>
      <span class="nav-label">Ads</span>
    </div>
    <div class="nav-item nav-task" onclick="window.location.href='tasks.html'">
      <div class="nav-icon"></div>
      <span class="nav-label">Tasks</span>
    </div>
    <div class="nav-item nav-wallet" onclick="window.location.href='wallet.html'">
      <div class="nav-icon"></div>
      <span class="nav-label">Wallet</span>
    </div>
  </div>

  <!-- Monetag Ad Script -->
  <!-- IMPORTANT: Replace with the correct Monetag script and configuration. -->
  <!-- This is a generic placeholder. You NEED to consult Monetag's documentation -->
  <!-- for the exact way to integrate and handle callbacks for rewarded ads. -->
  <script async="async" data-cfasync="false" src="//thubanoa.com/1?z=7834450"></script>

  <!-- If thubanoa.com exposes a function like show_9758754() that returns a Promise -->
  <!-- you would use it like this. Check their documentation. -->
  <!--
  <script>
    function initializeMonetagAds() {
      // Example for a rewarded ad function call.
      // Replace 'show_9758754' with the actual function name provided by Monetag.
      // This function should ideally be called when a user clicks a 'Watch Ad' button.
      // The promise resolution is where you grant the reward.

      // You might also need to check for Monetag's specific ad events or APIs.
      console.log("Monetag ad initialization might be needed here.");

      // Example of how to potentially use a function from thubanoa.com
      if (typeof show_9758754 === 'function') {
        console.log("Monetag show_9758754 function found.");
        window.monetagRewardedAdPromise = show_9758754; // Store for later use
      } else {
        console.warn("Monetag show_9758754 function not found. Ad might not work as expected.");
        window.monetagRewardedAdPromise = null; // Indicate no function available
      }
    }

    // Call this when the page loads or when the ad section is visible
    // initializeMonetagAds();
  </script>
  -->

  <!-- Firebase and Telegram Script -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // Firebase config (KEEP THIS SECURE IN A REAL APPLICATION!)
    const firebaseConfig = {
      apiKey: "AIzaSyDznXZYyJDmYmfWhjb3BwHa8bnu48Z0Ra4",
      authDomain: "panda-combat.firebaseapp.com",
      databaseURL: "https://panda-combat-default-rtdb.firebaseio.com",
      projectId: "panda-combat",
      storageBucket: "panda-combat.firebasestorage.app",
      messagingSenderId: "257385009837",
      appId: "1:257385009837:web:12429aa7bd48fe22baac24",
      measurementId: "G-FJB3CP1S5F"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Telegram Web App Initialization
    window.Telegram.WebApp.ready();
    const user = window.Telegram.WebApp.initDataUnsafe?.user;

    let userKey;
    let currentDogsBalance = 0;
    let currentUsdtBalance = 0; // Assuming USDT is also tracked
    let totalEarning = 0;
    let todayEarning = 0;

    if (user) {
      let displayName = user.username ? "@" + user.username : "ID: " + user.id;
      document.getElementById("telegram-id").textContent = displayName;
      userKey = String(user.id);
    } else {
      document.getElementById("telegram-id").textContent = "UNKNOWN_USER";
      userKey = "UNKNOWN_USER"; // Fallback for testing without Telegram
      console.warn("Telegram user not detected. Using fallback userKey.");
    }

    // Function to get today's date string in YYYY-MM-DD format
    function getTodayString() {
      const today = new Date();
      return today.toISOString().split('T')[0];
    }

    // Load user data from Firebase
    async function loadUserData() {
      if (userKey === "UNKNOWN_USER") {
        console.log("Skipping Firebase load for UNKNOWN_USER.");
        // Set default values if user is unknown to avoid errors, or handle differently
        currentDogsBalance = 0;
        currentUsdtBalance = 0;
        totalEarning = 0;
        todayEarning = 0;
        updateDisplays();
        return;
      }

      const userRef = ref(db, 'users/' + userKey);
      try {
        const snapshot = await get(userRef);
        if (snapshot.exists()) {
          const data = snapshot.val();
          currentDogsBalance = data.dogs ?? 0;
          currentUsdtBalance = data.usdt ?? 0;
          totalEarning = data.totalEarning ?? 0;

          const todayStr = getTodayString();
          todayEarning = data.dailyEarnings?.[todayStr] ?? 0;

          updateDisplays();
          console.log("User data loaded:", data);
        } else {
          // New user, initialize with some starting DOGS
          const defaultData = {
            dogs: 10, // Starting balance
            usdt: 0.00,
            totalEarning: 0,
            dailyEarnings: {}
          };
          await set(userRef, defaultData);
          console.log("New user created with default data:", defaultData);
          currentDogsBalance = defaultData.dogs;
          currentUsdtBalance = defaultData.usdt;
          totalEarning = defaultData.totalEarning;
          todayEarning = 0; // Reset today's earning for a new day/user
          updateDisplays();
        }
      } catch (e) {
        console.error("Firebase error loading user data:", e);
        document.getElementById('balance-display').textContent = "Error Loading";
      }
    }

    // Update all displayed values
    function updateDisplays() {
      document.getElementById('balance-display').textContent =
        `${currentDogsBalance} DOGS / ${currentUsdtBalance.toFixed(2)} USDT`;

      // Assuming 1 DOG = 0.001 USDT for display purposes, adjust if needed
      const totalEarningUsdt = totalEarning * 0.001;
      document.getElementById('total-earning').textContent =
        `${totalEarning} DOGS / ${totalEarningUsdt.toFixed(3)} USDT`;

      const todayEarningUsdt = todayEarning * 0.001;
      document.getElementById('today-earning').textContent =
        `${todayEarning} DOGS / ${todayEarningUsdt.toFixed(3)} USDT`;
    }

    // --- Ad Handling Functions ---

    // Function to simulate ad watching and progress to claim
    async function handleWatchAd(adButtonId, rewardAmountDogs) {
      const btn = document.getElementById(adButtonId);
      if (!btn) {
        console.error(`Button with ID ${adButtonId} not found.`);
        return;
      }

      // Prevent multiple clicks while ad is processing
      btn.disabled = true;

      // --- Monetag Specific Integration ---
      // This is where you'd ideally call Monetag's SDK function.
      // Example: If Monetag provides a `showRewardedAd` function that returns a Promise.
      // You must check Monetag's documentation for their actual implementation.

      let adCompleted = false;
      let adErrorMessage = null;

      // Check if the Monetag function is available from the script tag
      if (window.monetagRewardedAdPromise && typeof window.monetagRewardedAdPromise === 'function') {
        console.log("Attempting to show Monetag rewarded ad...");
        try {
          // Call the Monetag ad function. This function MUST resolve/reject
          // to indicate if the ad was watched and completed.
          await window.monetagRewardedAdPromise(); // Execute the Monetag ad function

          // If the promise resolves without throwing an error, assume ad completion.
          adCompleted = true;
          console.log("Monetag ad promise resolved successfully.");
        } catch (error) {
          adErrorMessage = "Ad failed to load or play. Please try again.";
          console.error("Monetag ad error:", error);
        }
      } else {
        console.warn("Monetag ad function not found or not initialized. Falling back to simulation.");
        // Fallback to simulation if Monetag's specific function isn't available
        // You could also show a simpler ad here if you have another provider.

        btn.className = 'ad-btn countdown-btn';
        btn.textContent = 'Starting...';

        await new Promise(resolve => setTimeout(resolve, 2000)); // Short delay before simulation

        let countdown = 15; // Simulate 15 seconds
        btn.textContent = `Watching... ${countdown}s`;

        const countdownInterval = setInterval(() => {
          countdown--;
          btn.textContent = `Watching... ${countdown}s`;
          if (countdown < 0) {
            clearInterval(countdownInterval);
            adCompleted = true; // Simulation complete
            console.log("Ad simulation completed.");
          }
        }, 1000);

        // Wait for the simulation to finish
        await new Promise(resolve => setTimeout(resolve, 15000 + 2000)); // Total simulation time
      }

      // --- Reward Logic ---
      if (adCompleted) {
        await claimAdReward(adButtonId, rewardAmountDogs);
      } else {
        // Ad did not complete (either Monetag failed or simulation was interrupted)
        btn.className = 'ad-btn watch-btn'; // Reset to watch state
        btn.disabled = false;
        btn.textContent = 'Watch Ad';
        alert(`Ad could not be completed. ${adErrorMessage ? adErrorMessage : ''}`);
        console.log("Ad not completed, reward not granted.");
      }
    }

    // Function to claim the reward from Firebase
    async function claimAdReward(adButtonId, rewardAmountDogs) {
      const btn = document.getElementById(adButtonId);

      // Ensure we are not already processing a claim
      if (btn.classList.contains('claim-btn') || btn.disabled) {
          console.log("Already claiming or button disabled.");
          return;
      }

      try {
        if (userKey === "UNKNOWN_USER") {
            alert("Cannot claim rewards: Unknown user.");
            return;
        }

        const userRef = ref(db, 'users/' + userKey);
        const todayStr = getTodayString();

        // Prepare update data
        const updateData = {
          dogs: currentDogsBalance + rewardAmountDogs,
          totalEarning: totalEarning + rewardAmountDogs,
          [`dailyEarnings/${todayStr}`]: todayEarning + rewardAmountDogs // Add to today's earnings
        };

        await update(userRef, updateData);

        // Update local variables for immediate UI feedback
        currentDogsBalance += rewardAmountDogs;
        totalEarning += rewardAmountDogs;
        todayEarning += rewardAmountDogs;

        updateDisplays(); // Refresh UI

        // Visually indicate successful claim
        alert(`üéâ You earned ${rewardAmountDogs} DOGS!`);

        // Reset button to watch state for next ad
        btn.className = 'ad-btn watch-btn';
        btn.disabled = false;
        btn.textContent = 'Watch Ad';
        // Re-attach the watch ad handler
        btn.onclick = () => handleWatchAd(adButtonId, rewardAmountDogs);

      } catch (error) {
        console.error("Error claiming ad reward:", error);
        alert('Error claiming reward. Please try again!');
        // Reset button on error
        btn.className = 'ad-btn watch-btn';
        btn.disabled = false;
        btn.textContent = 'Watch Ad';
        btn.onclick = () => handleWatchAd(adButtonId, rewardAmountDogs);
      }
    }

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
      loadUserData();

      // Set up click handlers for ad buttons
      const premiumAdButton = document.getElementById('ad-button-premium');
      if (premiumAdButton) {
        premiumAdButton.onclick = () => handleWatchAd('ad-button-premium', 10);
      }

      const sponsoredAdButton = document.getElementById('ad-button-sponsored');
      if (sponsoredAdButton) {
        // This button is "Coming Soon" as per your HTML.
        // If you later want to enable it, you'd set its onclick to call handleWatchAd.
        sponsoredAdButton.onclick = () => alert('This feature is coming soon! üéâ');
      }

      // Optional: Initialize Monetag if you have a specific function to call on load
      // if (typeof initializeMonetagAds === 'function') {
      //   initializeMonetagAds();
      // }
    });

    // Making functions available globally if needed (e.g., for ad network callbacks)
    // window.claimReward = claimReward; // Example if you need to call from outside
  </script>

</body>
</html>
